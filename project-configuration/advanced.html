<!DOCTYPE html> <html lang=en> <head> <meta charset=utf-8> <meta content='IE=edge' http-equiv=X-UA-Compatible> <meta content='width=device-width, initial-scale=1' name=viewport> <title>Cider-Ci Docs - Advanced Project Configuration</title> <link href="../assets/stylesheets/app-9123878f.css" rel=stylesheet /> <script src="../assets/javascripts/vendor-e7dce3cb.js"></script> <script src="../assets/javascripts/app-72be183c.js"></script> </head> <body id=the-cider-ci-documentation> <nav class='navbar navbar-inverse navbar-fixed-top'> <div class=container-fluid> <div class=navbar-header> <button aria-controls=navbar aria-expanded=false class='navbar-toggle collapsed' data-target='#navbar' data-toggle=collapse type=button> <span class=sr-only>Toggle navigation</span> <span class=icon-bar></span> <span class=icon-bar></span> <span class=icon-bar></span> </button> <a class=navbar-brand href="../">Cider-CI <span class=semantic-version><span class=major>3</span><span class=divider>.</span><span class=minor>2</span></span> Documentation </a></div> <div class='navbar-collapse collapse' id=navbar> <ul class='nav navbar-nav'> <li class=dropdown> <a class=dropdown-toggle data-toggle=dropdown href="#"><strong>Introduction</strong> <span class=caret></span> </a><ul class=dropdown-menu> <li> <a href="../introduction/">Introduction </a></li> </ul> </li> <li class=dropdown> <a class=dropdown-toggle data-toggle=dropdown href="#"><strong>Installation</strong> <span class=caret></span> </a><ul class=dropdown-menu> <li> <a href="../installation/">Installation </a></li> <li> <a href="../installation/executor-configuration.html">Executor Configuration </a></li> </ul> </li> <li class=dropdown> <a class=dropdown-toggle data-toggle=dropdown href="#"><strong>Project Configuration</strong> <span class=caret></span> </a><ul class=dropdown-menu> <li> <a href="./">Project Configuration </a></li> <li> <a href="dotfile.html">Dotfile </a></li> <li> <a href="jobs.html">Jobs </a></li> <li> <a href="tasks.html">Tasks </a></li> <li> <a href="scripts.html">Scripts </a></li> <li> <a href="advanced.html">Advanced Topics </a></li> </ul> </li> <li class=dropdown> <a class=dropdown-toggle data-toggle=dropdown href="#"><strong>API</strong> <span class=caret></span> </a><ul class=dropdown-menu> <li> <a href="../api/">API </a></li> <li> <a href="../api/api_resources.html">Core API Resources </a></li> <li> <a href="../api/storage_resources.html">Storage API Resources </a></li> </ul> </li> <li class=dropdown> <a class=dropdown-toggle data-toggle=dropdown href="#"><strong>Development</strong> <span class=caret></span> </a><ul class=dropdown-menu> <li> <a href="../development/architecture/">Architecture </a></li> <li> <a href="../development/setup/">Setup </a></li> </ul> </li> </ul> </div> </div> </nav> <div class=container-fluid> <div class=row> <div class='col-sm-3 col-md-2 sidebar'> <ul class='nav nav-sidebar'> <li class=''> <a class=alike href="../introduction/"><strong>Introduction</strong> </a></li> </ul> <ul class='nav nav-sidebar'> <li class=''> <a class=alike href="../installation/"><strong>Installation</strong> </a></li> <ul class='nav nav-sidebar'> <li class=''> <a href="../installation/executor-configuration.html">Executor Configuration </a></li> </ul> </ul> <ul class='nav nav-sidebar'> <li class=''> <a class=alike href="./"><strong>Project Configuration</strong> </a></li> <ul class='nav nav-sidebar'> <li class=''> <a href="dotfile.html">Dotfile </a></li> </ul> <ul class='nav nav-sidebar'> <li class=''> <a href="jobs.html">Jobs </a></li> </ul> <ul class='nav nav-sidebar'> <li class=''> <a href="tasks.html">Tasks </a></li> </ul> <ul class='nav nav-sidebar'> <li class=''> <a href="scripts.html">Scripts </a></li> </ul> <ul class='nav nav-sidebar'> <li class=active> <a href="advanced.html">Advanced Topics </a><ul class=toc></ul> </li> </ul> </ul> <ul class='nav nav-sidebar'> <li class=''> <a class=alike href="../api/"><strong>API</strong> </a></li> <ul class='nav nav-sidebar'> <li class=''> <a href="../api/api_resources.html">Core API Resources </a></li> </ul> <ul class='nav nav-sidebar'> <li class=''> <a href="../api/storage_resources.html">Storage API Resources </a></li> </ul> </ul> <ul class='nav nav-sidebar'> <li class=''> <span class=alike> <strong>Development</strong> </span> </li> <ul class='nav nav-sidebar'> <li class=''> <a href="../development/architecture/">Architecture </a></li> </ul> <ul class='nav nav-sidebar'> <li class=''> <a href="../development/setup/">Setup </a></li> </ul> </ul> </div> <div class='col-sm-9 col-sm-offset-3 col-md-10 col-md-offset-2 main'> <h1 class=no_toc id=advanced-topics>Advanced Topics</h1> <ul id=markdown-toc> <li><a id=markdown-toc-map-of-maps href="#map-of-maps">Map of Maps - Conceptual Mapping to Arrays</a></li> <li><a id=markdown-toc-including-files href="#including-files">Including Files</a></li> <li><a id=markdown-toc-generating-tasks href="#generating-tasks">Generating Tasks</a></li> <li><a id=markdown-toc-subcontexts href="#subcontexts">Subcontexts and Inheritance</a></li> <li><a id=markdown-toc-deep-merge href="#deep-merge">The Deep-Merge Strategy</a></li> </ul> <p>This page describes advanced features and techniques to keep the specification of the <a href="dotfile.html">Cider-CI Dotfile</a> maintainable and non repetitive.</p> <h2 id=map-of-maps>Map of Maps - Conceptual Mapping to Arrays</h2> <p>Maps are generally favored over arrays in the <a href="dotfile.html">Cider-CI Dotfile</a>. Maps are in general more flexible and in particular enable inclusion, see the section <a href="#including-files">Including Files</a>.<sup id="fnref:map-order"><a href="#fn:map-order" class=footnote>1</a></sup> The occurrences of "Map of Maps" are most prominently directly underneath <code>jobs</code>, <code>tasks</code> and <code>scripts</code>. During the evaluation of the dotfile these maps can be thought of as if they are transfered to arrays. The keys <code>name</code> and <code>key</code> on the second level are affected by this transformation. If the map on the second level does not have a <code>name</code> property it will be set to the name of the key. An existing <code>name</code> would not be overwritten. The property with the key <code>key</code> will be added/overridden with the value set to the name of the key.</p> <div class="highlight yaml"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class=lineno>1
2
3
4
5</pre></td><td class=code><pre><span class="s">jobs</span><span class="pi">:</span>
  <span class="s">job-x</span><span class="pi">:</span>
    <span class="s">key</span><span class="pi">:</span> <span class="s">I will be overwritten.</span>
  <span class="s">job-y</span><span class="pi">:</span>
    <span class="s">name</span><span class="pi">:</span> <span class="s">I will persist.</span>
</pre></td></tr></tbody></table> </div> <div class="highlight yaml"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class=lineno>1
2
3
4
5</pre></td><td class=code><pre><span class="s">jobs</span><span class="pi">:</span>
<span class="pi">-</span> <span class="s">key</span><span class="pi">:</span> <span class="s">job-x</span>
  <span class="s">name</span><span class="pi">:</span> <span class="s">job-x</span>
<span class="pi">-</span> <span class="s">key</span><span class="pi">:</span> <span class="s">job-y</span>
  <span class="s">name</span><span class="pi">:</span> <span class="s">I will persist.</span>
</pre></td></tr></tbody></table> </div> <h2 id=including-files>Including Files</h2> <p>One or more <em>YAML</em> files can be included via the <code>_cider-ci_include</code> key. The value of <code>_cider-ci_include</code> is a string or an array of strings.</p> <p>The <code>_cider-ci_include</code> may appear in any map at any level in the <a href="dotfile.html">Cider-CI Dotfile</a>.</p> <p>The top level element of the included file must be map. We note that this is not a restriction in what can be achieved with inclusion. The only allowed format for included files is <code>YAML</code> at this time. However, the content must compatible to the <code>JSON</code> format. The <code>JSON</code> format is more restrictive than <code>YAML</code>, it restricts key to be strings for example.</p> <p>A included map is merged into the current context with the <a href="#deep-merge">Deep-Merge</a> strategy: <code>deep_merge( current-map, file-map)</code>.</p> <p>If multiple files are included by specifying an array the map corresponding to the map of the first file is merged in the current context, then the map of the second file and so forth.</p> <p>It is legal to use the <code>_cider-ci_include</code> statement in files which are themselves to be included. The merging strategy will by applied recursively in <a href="//en.wikipedia.org/wiki/Depth-first_search">DFS</a> order until all includes are satisfied. It is illegal to define circular references.</p> <h2 id=generating-tasks>Generating Tasks</h2> <div class="highlight yaml"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class=lineno>1
2
3</pre></td><td class=code><pre><span class="s">_cider-ci_generate-tasks</span><span class="pi">:</span>
  <span class="s">include-match</span><span class="pi">:</span> <span class="s">spec/.*_spec.rb</span>
  <span class="s">exclude-match</span><span class="pi">:</span> <span class="s">spec/features.*_spec.rb</span>
</pre></td></tr></tbody></table> </div> <p>The <code>_cider-ci_generate-tasks</code> directive within the context or a subcontext can be used to generate tasks based on files checked into the repository. This is demonstrated in <a href="../demo-project/cider-ci/jobs/generate-tasks.yml">generate-tasks</a> example and more comprehensively <a href="https://github.com/Madek/madek-webapp/blob/madek-v3/.cider-ci/shared/tests-context.yml">here</a>. Conceptually, the result of <code>git ls-tree</code> is filtered according to the values of <code>include-match</code> and <code>exclude-match</code> which are interpreted as regular expressions.</p> <p>The result is a map of maps which is structurally equivalent to the value of the <code>tasks</code> key in the context. The full filename, with respect to the root of the repository, is used as <code>key</code> and is also set in the environment variable <code>CIDER_CI_TASK_FILE</code>.</p> <p>Additionally, an already existing <code>tasks</code> directive in the current context would be <a href="#deep-merge">deep-merged</a> with the one generated where values from the existing <code>tasks</code> directive would override those generated. Thus custom directives can be set on a task basis even for generated tasks as shown in the following example extracted from <a href="https://github.com/Madek/madek-webapp/blob/madek-v3/.cider-ci/shared/tests-context.yml">here</a>.</p> <div class="highlight yaml"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class=lineno>1
2
3
4
5
6
7
8
9</pre></td><td class=code><pre><span class="s">task-defaults</span><span class="pi">:</span>
  <span class="s">priority</span><span class="pi">:</span> <span class="s">2</span>

<span class="s">_cider-ci_generate-tasks</span><span class="pi">:</span>
  <span class="s">include-match</span><span class="pi">:</span> <span class="s">spec/features.*_spec.rb</span>

<span class="s">tasks</span><span class="pi">:</span>
  <span class="s2">"</span><span class="s">spec/features/styleguide_spec.rb"</span><span class="pi">:</span>
    <span class="s">priority</span><span class="pi">:</span> <span class="s">3</span>
</pre></td></tr></tbody></table> </div> <h2 id=subcontexts>Subcontexts and Inheritance</h2> <p>The main context, i.e. the map where tasks and related structures are defined, may contain the <code>subcontexts</code> directive. A subcontext can have exactly the same keys and values as the context. This includes the <code>subcontexts</code> directive itself.</p> <p>Subcontexts provide a way of inheritance which itself provides means to isolate some properties while maintaining shared properties in one place. A task in a subcontext not only inherits the directives of its own <code>task-defaults</code> but also those of the parent context. The precise rule is that the defaults from the context are passed down by applying the <a href="#deep-merge">Deep-Merge</a> strategy recursively: <code>deep_merge( deep_merge( task_defauls parent context, task-defaults current context), task)</code>.</p> <h2 id=deep-merge>The Deep-Merge Strategy</h2> <p>Inclusion and inheritance use a particular merging strategy which we call the <em>Deep-Merge</em> strategy. The canonic definition of <em>Deep-Merge</em> is mnemonic and easy to understand. The following almost formal definition will help to clarify doubts:</p> <p>Let <code>m1</code> and <code>m2</code> be a maps, and let <code>m</code> be the result of <code>deep_merge(m1, m2)</code> Then the following holds true:</p> <ol> <li> <p>If the key <code>k1</code> with the value <code>v1</code> is present in <code>m1</code> but not in <code>m2</code>, then the key value pair <code>(k1,v1)</code> is be present in <code>m</code>.</p> </li> <li> <p>If the key <code>k2</code> with the value <code>v2</code> is present in <code>m2</code> but not in <code>m1</code>, then the key value pair <code>(k2,v2)</code> is be present in <code>m</code>.</p> </li> <li> <p>If <code>k</code> is present in <code>m1</code> and <code>m2</code></p> <ol> <li> <p>and <code>v1</code> and <code>v2</code> are both maps, then the pair <code>(k, deep_merge(v1, v2))</code> is present in <code>m</code>.</p> </li> <li> <p>otherwise the pair <code>(k,v2)</code> is present in <code>m</code>.</p> </li> </ol> </li> </ol> <div class=footnotes> <ol> <li id="fn:map-order"> <p>The general downside is that maps, unlike arrays, don't guarantee a stable order (which is irrelevant for our use case). <a href="#fnref:map-order" class=reversefootnote>&#8617;</a></p> </li> </ol> </div> </div> </div> </div> </body> </html>