<!DOCTYPE html> <html lang=en> <head> <meta charset=utf-8> <meta content='IE=edge' http-equiv=X-UA-Compatible> <meta content='width=device-width, initial-scale=1' name=viewport> <title>Advanced Project Configuration - Cider-Ci Documentation</title> <link href="../assets/stylesheets/app-30beb77e.css" rel=stylesheet /> <script src="../assets/javascripts/vendor-ce938919.js"></script> <script src="../assets/javascripts/app-72be183c.js"></script> </head> <body id=the-cider-ci-documentation> <div class=container> <nav class='navbar navbar-inverse'> <div class=container-fluid> <div class=navbar-header> <a class=navbar-brand href="../">Cider-CI <span class=semantic-version><span class=major>3</span><span class=divider>.</span><span class=minor>8</span></span> Documentation </a></div> <form action='https://www.google.com/search' class='navbar-form navbar-left' method=get role=search> <div class=form-group> <input name=as_sitesearch type=hidden value='docs.cider-ci.info'> <input name=hl type=hidden value=en> <input class=form-control name=as_q placeholder=Search> <button class='btn btn-default' style='display: none' type=submit>Submit</button> </div> </form> <ul class='nav navbar-nav'> <li> <a href="../introduction/">Introduction </a></li> <li> <a href="../introduction/quick-start/">Quick-Start </a></li> <li> <a href="../sitemap.html">Sitemap </a></li> </ul> </div> </nav> <div class=row> <div class=col-md-6> <ol class=breadcrumb> <li> <a href="../">Home </a></li> <li> <a href="./">Project Configuration </a></li> <li> <a href="advanced.html">Advanced Topics </a></li> </ol> </div> <div class=col-md-6> </div> </div> <div class=content> <h1 class=no_toc id=advanced-topics>Advanced Topics</h1> <ul id=markdown-toc> <li><a id=markdown-toc-map-of-maps href="#map-of-maps">Map of Maps - Conceptual Mapping to Arrays</a></li> <li><a id=markdown-toc-including-files href="#including-files">Including Files</a></li> <li><a id=markdown-toc-generating-tasks href="#generating-tasks">Generating Tasks</a></li> <li><a id=markdown-toc-subcontexts href="#subcontexts">Subcontexts and Inheritance</a></li> <li><a id=markdown-toc-deep-merge href="#deep-merge">The Deep-Merge Strategy</a></li> </ul> <p>This page describes advanced features and techniques to keep the specification of the <a href="configuration-file.html">Cider-CI Configuration File</a> maintainable and non repetitive.</p> <h2 id=map-of-maps>Map of Maps - Conceptual Mapping to Arrays</h2> <p>Maps are generally favored over arrays in the <a href="configuration-file.html">Cider-CI Configuration File</a>. Maps are in general more flexible and in particular enable inclusion, see the section <a href="#including-files">Including Files</a>.<sup id="fnref:map-order"><a href="#fn:map-order" class=footnote>1</a></sup> The occurrences of "Map of Maps" are most prominently directly underneath <code>jobs</code>, <code>tasks</code> and <code>scripts</code>. During the evaluation of the configuration these maps can be thought of as if they are transfered to arrays. The keys <code>name</code> and <code>key</code> on the second level are affected by this transformation. If the map on the second level does not have a <code>name</code> property it will be set to the name of the key. An existing <code>name</code> would not be overwritten. The property with the key <code>key</code> will be added/overridden with the value set to the name of the key.</p> <div class=highlighter-coderay><div class=CodeRay> <div class=code><pre><span class="line-numbers"><a href="#n1" name="n1">1</a></span><span style="color:#606">jobs</span>:
<span class="line-numbers"><a href="#n2" name="n2">2</a></span>  <span style="color:#606">job-x</span>:
<span class="line-numbers"><a href="#n3" name="n3">3</a></span>    <span style="color:#606">key</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">I will be overwritten.</span></span>
<span class="line-numbers"><a href="#n4" name="n4">4</a></span>  <span style="color:#606">job-y</span>:
<span class="line-numbers"><a href="#n5" name="n5">5</a></span>    <span style="color:#606">name</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">I will persist.</span></span>
</pre></div> </div> </div> <div class=highlighter-coderay><div class=CodeRay> <div class=code><pre><span class="line-numbers"><a href="#n1" name="n1">1</a></span><span style="color:#606">jobs</span>:
<span class="line-numbers"><a href="#n2" name="n2">2</a></span>- <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">key: job-x</span></span>
<span class="line-numbers"><a href="#n3" name="n3">3</a></span>  <span style="color:#606">name</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">job-x</span></span>
<span class="line-numbers"><a href="#n4" name="n4">4</a></span>- <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">key: job-y</span></span>
<span class="line-numbers"><a href="#n5" name="n5">5</a></span>  <span style="color:#606">name</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">I will persist.</span></span>
</pre></div> </div> </div> <h2 id=including-files>Including Files</h2> <p>One or more <em>YAML</em> files can be included via the <code>_cider-ci_include</code> key. The value of <code>_cider-ci_include</code> is a string or an array of strings.</p> <p>The <code>_cider-ci_include</code> may appear in any map at any level in the <a href="configuration-file.html">Cider-CI Configuration File</a>.</p> <p>The top level element of the included file must be map. We note that this is not a restriction in what can be achieved with inclusion. The only allowed format for included files is <code>YAML</code> at this time. However, the content must compatible to the <code>JSON</code> format. The <code>JSON</code> format is more restrictive than <code>YAML</code>, it restricts key to be strings for example.</p> <p>A included map is merged into the current context with the <a href="#deep-merge">Deep-Merge</a> strategy: <code>deep_merge( current-map, file-map)</code>.</p> <p>If multiple files are included by specifying an array the map corresponding to the map of the first file is merged in the current context, then the map of the second file and so forth.</p> <p>It is legal to use the <code>_cider-ci_include</code> statement in files which are themselves to be included. The merging strategy will by applied recursively in <a href="http://en.wikipedia.org/wiki/Depth-first_search">DFS</a> order until all includes are satisfied. It is illegal to define circular references.</p> <h2 id=generating-tasks>Generating Tasks</h2> <div class=highlighter-coderay><div class=CodeRay> <div class=code><pre><span class="line-numbers"><a href="#n1" name="n1">1</a></span><span style="color:#606">_cider-ci_generate-tasks</span>:
<span class="line-numbers"><a href="#n2" name="n2">2</a></span>  <span style="color:#606">include-match</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">spec/.*_spec.rb</span></span>
<span class="line-numbers"><a href="#n3" name="n3">3</a></span>  <span style="color:#606">exclude-match</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">spec/features.*_spec.rb</span></span>
</pre></div> </div> </div> <p>The <code>_cider-ci_generate-tasks</code> directive within the context or a subcontext can be used to generate tasks based on files checked into the repository. This is demonstrated in <a href="../demo-project/cider-ci/jobs/generate-tasks.yml">generate-tasks</a> example and more comprehensively <a href="https://github.com/Madek/madek-webapp/blob/madek-v3/cider-ci/jobs/feature-tests.yml#L127-L128">here</a>. Conceptually, the result of <code>git ls-tree</code> is filtered according to the values of <code>include-match</code> and <code>exclude-match</code> which are interpreted as regular expressions.</p> <p>The result is a map of maps which is structurally equivalent to the value of the <code>tasks</code> key in the context. The full filename, with respect to the root of the repository, is used as <code>key</code> and is also set in the environment variable <code>CIDER_CI_TASK_FILE</code>.</p> <p>Additionally, an already existing <code>tasks</code> directive in the current context would be <a href="#deep-merge">deep-merged</a> with the one generated where values from the existing <code>tasks</code> directive would override those generated. Thus custom directives can be set on a task basis even for generated tasks as shown in the following example extracted from <a href="https://github.com/Madek/madek-webapp/blob/madek-v3/cider-ci/jobs/feature-tests.yml#L97-L128">here</a>.</p> <div class=highlighter-coderay><div class=CodeRay> <div class=code><pre><span class="line-numbers"><a href="#n1" name="n1">1</a></span><span style="color:#606">tasks</span>:
<span class="line-numbers"><a href="#n2" name="n2">2</a></span>  <span style="color:#606"><span style="color:#404">&quot;</span><span>spec/features/custom_root-url_spec.rb</span><span style="color:#404">&quot;</span></span>:
<span class="line-numbers"><a href="#n3" name="n3">3</a></span>    <span style="color:#606">environment-variables</span>:
<span class="line-numbers"><a href="#n4" name="n4">4</a></span>      <span style="color:#606">RAILS_RELATIVE_URL_ROOT</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">/my-test</span></span>
<span class="line-numbers"><a href="#n5" name="n5">5</a></span>
<span class="line-numbers"><a href="#n6" name="n6">6</a></span><span style="color:#606">_cider-ci_generate-tasks</span>:
<span class="line-numbers"><a href="#n7" name="n7">7</a></span>  <span style="color:#606">include-match</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">spec/features.*_spec.rb</span></span>
</pre></div> </div> </div> <h2 id=subcontexts>Subcontexts and Inheritance</h2> <p>The main context, i.e. the map where tasks and related structures are defined, may contain the <code>subcontexts</code> directive. A subcontext can have exactly the same keys and values as the context. This includes the <code>subcontexts</code> directive itself.</p> <p>Subcontexts provide a way of inheritance which itself provides means to isolate some properties while maintaining shared properties in one place. A task in a subcontext not only inherits the directives of its own <code>task-defaults</code> but also those of the parent context. The precise rule is that the defaults from the context are passed down by applying the <a href="#deep-merge">Deep-Merge</a> strategy recursively: <code>deep_merge( deep_merge( task_defauls parent context, task-defaults current context), task)</code>.</p> <h2 id=deep-merge>The Deep-Merge Strategy</h2> <p>Inclusion and inheritance use a particular merging strategy which we call the <em>Deep-Merge</em> strategy. The canonic definition of <em>Deep-Merge</em> is mnemonic and easy to understand. The following almost formal definition will help to clarify doubts:</p> <p>Let <code>m1</code> and <code>m2</code> be a maps, and let <code>m</code> be the result of <code>deep_merge(m1, m2)</code> Then the following holds true:</p> <ol> <li> <p>If the key <code>k1</code> with the value <code>v1</code> is present in <code>m1</code> but not in <code>m2</code>, then the key value pair <code>(k1,v1)</code> is be present in <code>m</code>.</p> </li> <li> <p>If the key <code>k2</code> with the value <code>v2</code> is present in <code>m2</code> but not in <code>m1</code>, then the key value pair <code>(k2,v2)</code> is be present in <code>m</code>.</p> </li> <li> <p>If <code>k</code> is present in <code>m1</code> and <code>m2</code></p> <ol> <li> <p>and <code>v1</code> and <code>v2</code> are both maps, then the pair <code>(k, deep_merge(v1, v2))</code> is present in <code>m</code>.</p> </li> <li> <p>otherwise the pair <code>(k,v2)</code> is present in <code>m</code>.</p> </li> </ol> </li> </ol> <div class=footnotes> <ol> <li id="fn:map-order"> <p>The general downside is that maps, unlike arrays, don't guarantee a stable order (which is irrelevant for our use case). <a href="#fnref:map-order" class=reversefootnote>&#8617;</a></p> </li> </ol> </div> </div> </div> </body> </html>