<!DOCTYPE html> <html lang=en> <head> <meta charset=utf-8> <meta content='IE=edge' http-equiv=X-UA-Compatible> <meta content='width=device-width, initial-scale=1' name=viewport> <title>Cider-Ci Docs - Advanced Project Configuration</title> <link href="../assets/stylesheets/app-228cffb1.css" rel=stylesheet /> <script src="../assets/javascripts/vendor-e7dce3cb.js"></script> <script src="../assets/javascripts/app-72be183c.js"></script> </head> <body id=the-cider-ci-documentation> <nav class='navbar navbar-inverse navbar-fixed-top'> <div class=container-fluid> <div class=navbar-header> <button aria-controls=navbar aria-expanded=false class='navbar-toggle collapsed' data-target='#navbar' data-toggle=collapse type=button> <span class=sr-only>Toggle navigation</span> <span class=icon-bar></span> <span class=icon-bar></span> <span class=icon-bar></span> </button> <a class=navbar-brand href="../">Cider-CI <span class=semantic-version><span class=major>2</span><span class=minor><span class=divider>.</span>4</span><span class=minor><span class=divider>.</span>0</span><span class=version><span class=divider>-</span>BETA.8</span></span> Documentation </a></div> <div class='navbar-collapse collapse' id=navbar> <ul class='nav navbar-nav'> <li class=dropdown> <a class=dropdown-toggle data-toggle=dropdown href="#"><strong>Install</strong> <span class=caret></span> </a><ul class=dropdown-menu> <li> <a href="../install/">Install </a></li> </ul> </li> <li class=dropdown> <a class=dropdown-toggle data-toggle=dropdown href="#"><strong>Project Configuration</strong> <span class=caret></span> </a><ul class=dropdown-menu> <li> <a href="./">Project Configuration </a></li> <li> <a href="dotfile.html">Dotfile </a></li> <li> <a href="specification/">Job Specification </a></li> <li> <a href="task.html">Task Specification </a></li> <li> <a href="scripts.html">Script Specification </a></li> <li> <a href="advanced.html">Advanced Topics </a></li> </ul> </li> <li class=dropdown> <a class=dropdown-toggle data-toggle=dropdown href="#"><strong>API</strong> <span class=caret></span> </a><ul class=dropdown-menu> <li> <a href="../api/">API </a></li> <li> <a href="../api/api_resources.html">Core API Resources </a></li> <li> <a href="../api/storage_resources.html">Storage API Resources </a></li> </ul> </li> <li class=dropdown> <a class=dropdown-toggle data-toggle=dropdown href="#"><strong>Development</strong> <span class=caret></span> </a><ul class=dropdown-menu> <li> <a href="../development/architecture/">Architecture </a></li> <li> <a href="../development/setup/">Setup </a></li> </ul> </li> </ul> </div> </div> </nav> <div class=container-fluid> <div class=row> <div class='col-sm-3 col-md-2 sidebar'> <ul class='nav nav-sidebar'> <li class=''> <a class=alike href="../install/"><strong>Install</strong> </a></li> </ul> <ul class='nav nav-sidebar'> <li class=''> <a class=alike href="./"><strong>Project Configuration</strong> </a></li> <ul class='nav nav-sidebar'> <li class=''> <a href="dotfile.html">Dotfile </a></li> </ul> <ul class='nav nav-sidebar'> <li class=''> <a href="specification/">Job Specification </a></li> </ul> <ul class='nav nav-sidebar'> <li class=''> <a href="task.html">Task Specification </a></li> </ul> <ul class='nav nav-sidebar'> <li class=''> <a href="scripts.html">Script Specification </a></li> </ul> <ul class='nav nav-sidebar'> <li class=active> <a href="advanced.html">Advanced Topics </a><ul class=toc></ul> </li> </ul> </ul> <ul class='nav nav-sidebar'> <li class=''> <a class=alike href="../api/"><strong>API</strong> </a></li> <ul class='nav nav-sidebar'> <li class=''> <a href="../api/api_resources.html">Core API Resources </a></li> </ul> <ul class='nav nav-sidebar'> <li class=''> <a href="../api/storage_resources.html">Storage API Resources </a></li> </ul> </ul> <ul class='nav nav-sidebar'> <li class=''> <span class=alike> <strong>Development</strong> </span> </li> <ul class='nav nav-sidebar'> <li class=''> <a href="../development/architecture/">Architecture </a></li> </ul> <ul class='nav nav-sidebar'> <li class=''> <a href="../development/setup/">Setup </a></li> </ul> </ul> </div> <div class='col-sm-9 col-sm-offset-3 col-md-10 col-md-offset-2 main'> <h1 class=no_toc id=advanced-topics>Advanced Topics</h1> <ul id=markdown-toc> <li><a id=markdown-toc-including-files href="#including-files">Including Files</a></li> <li><a id=markdown-toc-subcontexts href="#subcontexts">Subcontexts</a></li> <li><a id=markdown-toc-deep-merge href="#deep-merge">The Deep-Merge Strategy</a></li> </ul> <p>This page describes advanced features and techniques to keep the job specification maintainable and non repetitive.</p> <h2 id=including-files>Including Files</h2> <p>One or more <em>YAML</em> files can be included via the <code>_cider-ci_include</code> key. The value of <code>_cider-ci_include</code> is a string or an array of strings.</p> <p>The <code>_cider-ci_include</code> key may not appear anywhere else than in the Cider-CI dotfile other than in the specification of an job. It may however appear at any level. The value must equal the absolute path of the file to be included. The absolute reference is the top level directory according to git.</p> <div class="highlight yaml"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class=lineno>1
2
3
4</pre></td><td class=code><pre><span class="s">jobs</span><span class="pi">:</span>
  <span class="s2">"</span><span class="s">Submodule-Demo"</span><span class="pi">:</span>
    <span class="s">specification</span><span class="pi">:</span> 
      <span class="s">_cider-ci_include</span><span class="pi">:</span> <span class="s">/.cider-ci/shared/submodule_context.yml</span>
</pre></td></tr></tbody></table> </div> <p>The top level element of the included file must be map. This map is merged into the current context with the <a href="#deep-merge">Deep-Merge</a> strategy: <code>deep_merge( current-map, file-map)</code>.</p> <div class="highlight yaml"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class=lineno>1
2
3</pre></td><td class=code><pre><span class="s">_cider-ci_include</span><span class="pi">:</span> 
  <span class="pi">-</span> <span class="s1">'</span><span class="s">/.cider-ci/partials/code-check_defaults.yml'</span>
  <span class="pi">-</span> <span class="s1">'</span><span class="s">/.cider-ci/tasks/code-check.yml'</span>
</pre></td></tr></tbody></table> </div> <p>If multiple files are included by specifying an array the map corresponding to the map of the first file is merged in the current context, then the map of the second file and so forth.</p> <p>It is legal to use the <code>_cider-ci_include</code> statement in files which are themselves to be included. The merging strategy will by applied recursively until all includes are satisfied. It is illegal to define circular references.</p> <h2 id=subcontexts>Subcontexts</h2> <p>The main context, i.e. the map <code>specification</code> in the dot-file may contain the <code>subcontexts</code> directive. A subcontext can have exactly the same keys and values as the job specification, i.e. the main context. This includes the <code>subcontexts</code> directive itself.</p> <p>Subcontexts provide a way of inheritance which itself provides means to keep the specification succinct and non repetitive. A task in a subcontext not only inherits the directives of its own <code>task_defaults</code> but also those of the parent context. The precise rule is that the defaults from the main context are passed down by applying the <a href="#deep-merge">Deep-Merge</a> strategy recursively: <code>deep_merge( deep_merge( task_defauls parent context, task_defaults current context), task)</code>.</p> <div class="highlight yaml"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class=lineno>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23</pre></td><td class=code><pre><span class="s">specification</span><span class="pi">:</span>

  <span class="s">name</span><span class="pi">:</span> <span class="s">Tests</span>

    <span class="s">task_defaults</span><span class="pi">:</span> 
      <span class="s">traits</span><span class="pi">:</span>
        <span class="s">ruby</span><span class="pi">:</span> <span class="s">true</span>

    <span class="s">subcontexts</span><span class="pi">:</span>

      <span class="s">standard</span><span class="pi">:</span>

        <span class="s">tasks</span><span class="pi">:</span>
          <span class="s">_cider-ci_include</span><span class="pi">:</span> <span class="s">/.cider-ci/tasks/rspec-tasks.yml</span>

      <span class="s">integration</span><span class="pi">:</span>

       <span class="s">task_defaults</span><span class="pi">:</span>
        <span class="s">traits</span><span class="pi">:</span>
          <span class="s">firefox-esr</span><span class="pi">:</span> <span class="s">true</span>

        <span class="s">tasks</span><span class="pi">:</span>
          <span class="s">_cider-ci_include</span><span class="pi">:</span> <span class="s">/.cider-ci/tasks/rspec-feature-tasks.yml</span>
</pre></td></tr></tbody></table> </div> <p>In the example above, every task in the integration context will have the traits <code>ruby</code> as well as <code>firefox-esr</code> enabled. However, the tasks in the main context would only have the trait <code>ruby</code> enabled.</p> <h2 id=deep-merge>The Deep-Merge Strategy</h2> <p>Inclusion and inheritance use a particular merging strategy which we call the <em>Deep-Merge</em> strategy. The canonic definition of <em>Deep-Merge</em> is mnemonic and easy to understand. The following almost formal definition will help to clarify doubts:</p> <p>Let <code>m1</code> and <code>m2</code> be a maps, and let <code>m</code> be the result of <code>deep_merge(m1, m2)</code> Then the following holds true:</p> <ol> <li> <p>If the key <code>k1</code> with the value <code>v1</code> is present in <code>m1</code> but not in <code>m2</code>, then the key value pair <code>(k1,v1)</code> is be present in <code>m</code>.</p> </li> <li> <p>If the key <code>k2</code> with the value <code>v2</code> is present in <code>m2</code> but not in <code>m1</code>, then the key value pair <code>(k2,v2)</code> is be present in <code>m</code>.</p> </li> <li> <p>If <code>k</code> is present in <code>m1</code> and <code>m2</code></p> <ol> <li> <p>and <code>v1</code> and <code>v2</code> are both maps, then the pair <code>(k, deep_merge(v1, v2))</code> is present in <code>m</code>.</p> </li> <li> <p>otherwise the pair <code>(k,v2)</code> is present in <code>m</code>.</p> </li> </ol> </li> </ol> </div> </div> </div> </body> </html>